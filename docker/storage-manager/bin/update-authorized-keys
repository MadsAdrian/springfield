#!/bin/sh

set -eu

copy_ssh_keys() {
  find "$SSH_KEYS_DIR" -type f -print0 | xargs -0 cat > "$HOME/.ssh/authorized_keys"
}

watch_ssh_keys_dir() {
  while inotifywait -qq -e close_write -e create -e delete "$SSH_KEYS_DIR"; do
    copy_ssh_keys
  done
}

# Ensure .ssh directory exists, and has correct permissions.
mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"
chown -R $(id -u):$(id -g) "$HOME/.ssh"

# Copy all keys found in directory to .ssh/authorized_keys.
copy_ssh_keys

# Watch the SSH keys directory for file changes.
watch_ssh_keys_dir &
